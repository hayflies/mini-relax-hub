{% extends "base.html" %}
{% block head %}
<style>
    .drawing-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .drawing-controls input[type="color"] {
        width: 48px;
        height: 32px;
        padding: 0;
    }
    .drawing-controls button {
        padding: 0.35rem 0.75rem;
        font-size: 0.9rem;
    }
    .drawing-gallery img {
        max-width: 180px;
        height: auto;
        display: block;
        margin: 0 auto;
    }
</style>
{% endblock %}
{% block content %}
<h2>그림 그리기</h2>
<p>펜 색상을 선택한 뒤 캔버스에 그림을 그리고 저장하세요.</p>
<div class="drawing-controls">
    <label for="color" style="margin:0;">펜 색상</label>
    <input type="color" id="color" value="#000000" />
    <button id="clear" class="secondary">지우기</button>
    <button id="save">저장</button>
</div>
<div>
    <canvas id="canvas" width="500" height="360"></canvas>
</div>

<h3>내가 저장한 그림</h3>
<div class="grid drawing-gallery">
    {% for drawing in drawings %}
        <div class="game-card">
            <p>{{ drawing.created_at }}</p>
            <img src="{{ MEDIA_URL }}{{ drawing.image_path }}" alt="drawing" />
        </div>
    {% empty %}
        <p>아직 저장된 그림이 없습니다.</p>
    {% endfor %}
</div>

<form id="save-form" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="image_data" id="image-data" />
</form>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let drawing = false;
let color = document.getElementById('color').value;

canvas.addEventListener('mousedown', () => { drawing = true; });
canvas.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
canvas.addEventListener('mousemove', draw);
document.getElementById('color').addEventListener('change', (e) => { color = e.target.value; });

document.getElementById('clear').addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
});

document.getElementById('save').addEventListener('click', () => {
    const dataUrl = canvas.toDataURL('image/png');
    document.getElementById('image-data').value = dataUrl;
    document.getElementById('save-form').submit();
});

function draw(event) {
    if (!drawing) return;
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    ctx.strokeStyle = color;
    ctx.lineTo(event.offsetX, event.offsetY);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(event.offsetX, event.offsetY);
}
</script>
{% endblock %}
